# Web 2D 打字小游戏设计文档

## 1. 项目概览
- **名称**：Little Key Rangers（暂定）
- **主题概念**：小游侠立于城墙之上，使用弓箭射击带有单词的下落敌人，守护城池。
- **类型**：基于浏览器的 2D 打字闯关/无尽小游戏。
- **目标平台**：桌面端现代浏览器（Chromium、Firefox、Safari）。
- **主要引擎**：Phaser 3。
- **技术栈**：TypeScript、Vite、Phaser 3、HTML5 Canvas。
- **目标用户**：希望通过轻松的小游戏锻炼打字速度与准确率的休闲玩家。

## 2. 核心玩法与体验
1. 玩家操纵城墙上的游侠，通过键入敌人身上的单词来放箭，射中后击落敌人。
2. 敌人携带不同单词沿预定路径自天空落向城墙，若未在入侵前击倒则对城墙造成伤害。
3. 击中敌人会触发箭矢命中特效、连击与得分奖励；输入错误会使连击重置并给予震动/警示反馈。
4. 特殊敌人或道具会掉落“炸弹”，触发后清除屏幕内所有敌人并重置压力。
5. 游戏提供多种关卡、词库与难度组合，随波次提升敌人速度、路径变化与炸弹需求。

## 3. 系统架构与目录规划
```
/src
  /assets
    /audio
    /fonts
    /images
  /config
    wordPools/
      easy.json
      medium.json
      hard.json
    stages.json
  /core
    GameConfig.ts
    BootScene.ts
    UIScene.ts
    AudioManager.ts
    EventBus.ts
    StorageService.ts
  /entities
    Enemy.ts
    Ranger.ts
    Arrow.ts
    Bomb.ts
    PlayerStats.ts
    WordBubble.ts
  /states
    MenuScene.ts
    PlayScene.ts
    PauseScene.ts
    ResultScene.ts
    EndlessScene.ts
  /systems
    TypingSystem.ts
    EnemySpawner.ts
    ComboSystem.ts
    ScoreSystem.ts
    BombSystem.ts
    TrajectorySystem.ts
  /ui
    components/
      Button.ts
      Dialog.ts
      ProgressBar.ts
  index.html
  main.ts
```

- **核心模块划分**
  - `core`：Phaser 配置、全局系统与辅助类。
  - `states`：游戏状态/场景（菜单、游戏、结算等）。
  - `systems`：与场景解耦的逻辑系统（输入、敌人轨迹、炸弹、评分等）。
  - `entities`：游侠、敌人、箭矢、炸弹等游戏实体的数据与行为描述。
  - `config`：词库、关卡、敌人路径、炸弹规则等数据配置。
  - `ui`：UI 组件封装（按钮、进度条、对话框等）。

- **敌人下落路径与行为**
  - `TrajectorySystem` 读取 `stages.json` 中的路径定义（直线、抛物、曲线），计算敌人在每帧的位移与朝向。
  - 敌人包含多段行为状态：入场、携带单词、受击、坠落、撞击城墙；状态变化通过事件广播给 UI 与音效。

- **命中判定**
  - `TypingSystem` 将当前输入与敌人单词逐字符比对，当单词完成时触发 `arrow:release` 事件。
  - `Arrow` 实体沿游侠到敌人的弹道飞行，命中后调用敌人 `takeHit()`，触发爆裂动画和得分。
  - 支持多箭排队：若有多个敌人完成输入，则依照完成顺序依次射出，避免误判。

- **炸弹清屏机制**
  - `BombSystem` 监听炸弹拾取与触发事件，可来自特殊敌人、连击奖励或关卡脚本。
  - 激活炸弹时播放蓄力动画，随后对所有在场敌人调用 `forceEliminate()`，并对 HUD 输出冷却/次数更新。

- **词库与敌人绑定关系**
  - `EnemySpawner` 根据关卡配置从对应 `wordPool` 中取词，并写入敌人实例。
  - 支持同一波敌人使用主题词组；特殊敌人可绑定特定难度或语法类别，增强学习目标。
  - 词库与敌人类型映射存于 `stages.json` 的 `wordGroups` 字段，方便扩展。

## 4. 场景与状态流程
1. **BootScene**：预加载游侠、城墙、箭矢、敌人、炸弹等资源（图片、音效、字体、配置 JSON），完成后跳转到 `MenuScene`。
2. **MenuScene**：展示主题城墙背景、模式选择、词库说明。点击“开始守城”进入 `PlayScene` 或选择无尽模式进入 `EndlessScene`。
3. **PlayScene**：
   - 初始化游侠站位、城墙耐久度、HUD；
   - 调度 `EnemySpawner` 按波次自顶部生成敌人，调用 `TrajectorySystem` 控制敌人下落路径与速度；
   - `TypingSystem` 处理输入并触发箭矢发射，`BombSystem` 维护炸弹充能与触发；
   - 敌人落地时触发城墙受击动画，若耐久归零则结束关卡。
4. **PauseScene**：暂停并遮罩场景，提供继续、重开、返回主菜单选项。
5. **ResultScene**：展示守城成果（得分、准确率、最高连击、炸弹使用次数），记录词库表现并提供重试。
6. **EndlessScene**：无尽模式持续生成敌人，逐步提高下落速度与路径复杂度，炸弹冷却缩短以应对高压。

## 5. 核心系统设计
### 5.1 TypingSystem（输入系统）
- 监听键盘事件，维护玩家当前目标敌人队列。
- 与敌人单词逐字符对比，高亮正确部分，错误时闪烁敌人并播放警告音。
- 单词完成后触发 `arrow:release`，向 `Arrow` 对象池申请箭矢实体。
- 支持 Backspace 撤销、Tab 切换目标、特殊键触发炸弹。

### 5.2 EnemySpawner（敌人生成）
- 按关卡配置（波次、路径、速度、携带词组）生成敌人对象。
- 控制同屏敌人数、重用对象池，支持携带炸弹的特殊敌人。
- 敌人到达城墙触发 `enemy:breached`，导致城墙耐久减少与 HUD 更新。

### 5.3 TrajectorySystem（轨迹系统）
- 解析路径样式（直线、S 曲线、随机漂移）并提供位置插值。
- 支持下落过程中改变速度或触发停顿，为 Boss 设计预留接口。

### 5.4 Arrow/Bomb System（箭矢与炸弹系统）
- 箭矢根据游侠位置与敌人位置计算飞行时间，命中后触发敌人坠落与得分。
- 炸弹可通过快捷键或 UI 按钮触发，瞬间对敌人数组应用清除效果，伴随屏幕闪光与音浪。

### 5.5 Score & Combo System（评分与连击）
- 击败敌人累积分数，连击提升倍率，炸弹击杀按敌人数额外奖励。
- 统计输入字符数、错误数，用于计算准确率、WPM、最高连击与炸弹使用效率。
- 连击达到阈值可自动掉落炸弹或提供箭矢强化。

### 5.6 PlayerStats（玩家状态）
- 维护城墙耐久、游侠护盾、炸弹库存、技能冷却等。
- 提供接口响应敌人攻击、输入失误、炸弹触发，并判断游戏失败条件。

### 5.7 AudioManager
- 统一管理背景音乐、箭矢、炸弹、敌人坠落等音效，支持音量调节与静音。
- 对命中、连击、炸弹释放设立独立声道，避免声音遮蔽。

### 5.8 StorageService
- 基于 LocalStorage 保存最高分、最佳准确率、炸弹使用记录、设置与解锁内容。
- 预留接口扩展云端排行榜或教学模式数据同步。

## 6. 数据配置
### 6.1 关卡配置
- `config/stages.json` 定义背景、音乐、敌人波次、路径与炸弹掉落概率等。
- 示例：
```json
{
  "id": "stage1",
  "name": "城门训练场",
  "background": "bg_wall",
  "music": "track_easy",
  "wordPool": "easy",
  "spawn": {
    "waves": [
      { "time": 0, "count": 5, "interval": 1500, "path": "straight" },
      { "time": 15000, "count": 6, "interval": 1200, "path": "zigzag" },
      { "time": 28000, "count": 1, "interval": 0, "path": "boss", "type": "bombCarrier" }
    ],
    "maxConcurrent": 4
  },
  "bomb": {
    "initial": 1,
    "cooldown": 20000,
    "comboReward": 15
  },
  "winCondition": { "type": "defend", "duration": 60000 },
  "lossCondition": { "type": "wall", "hp": 3 }
}
```

### 6.2 词库配置
- `config/wordPools/*.json` 管理不同难度与语言的词库，并附带主题标签。
- 示例 `easy.json`：
```json
{
  "language": "en",
  "difficulty": "easy",
  "tags": ["castle", "basic"],
  "words": ["bow", "wall", "hero", "guard", "shield"]
}
```

### 6.3 敌人与词库绑定
- `stages.json` 中的 `wordGroups` 数组允许指定“飞龙敌人使用长度≥6 的单词”“炸弹携带者使用数字词”等规则。
- `EnemySpawner` 根据敌人类型读取绑定规则，保证教学目标与敌人表现一致。

### 6.4 成就/任务
- 可选 `config/achievements.json` 记录解锁条件与奖励，如 `{"id": "bomb_master", "desc": "单局使用炸弹清除20名敌人", "reward": "title_bomb_master"}`。

## 7. UI、HUD、音效与美术表现
- **HUD**：
  - 显示城墙耐久度、游侠护盾、当前连击、分数、WPM、炸弹库存与冷却条。
  - 当敌人接近城墙时 HUD 边框变红闪烁；炸弹可用时高亮提示。
  - 炸弹触发后 HUD 显示“城墙安然无恙”文字动画并重置敌人警报。
- **音效**：
  - 游侠拉弓、放箭、箭矢命中各自拥有节奏分明的音效，命中长词给予更厚重反馈。
  - 敌人撞击城墙播放沉重撞击声；炸弹触发播放低频蓄力+爆破声并伴随观众欢呼。
  - 连击提升与警告状态使用短促提示音，保证玩家即时掌握战况。
- **美术**：
  - 背景展现坚固城墙与远处城镇，随关卡更换时间与天气。
  - 游侠立于城垛，放箭时有拉弓姿态与箭矢光迹；高连击时衣着发光或披风飘扬。
  - 敌人样式体现所携带词汇主题，坠落时有烟尘或破碎特效。
  - 炸弹以魔法水晶或火药桶形式出现，激活时屏幕中央爆发冲击波并清除敌人残影。

## 8. 游戏循环示意
```ts
class PlayScene extends Phaser.Scene {
  private typingSystem!: TypingSystem;
  private enemySpawner!: EnemySpawner;
  private trajectorySystem!: TrajectorySystem;
  private scoreSystem!: ScoreSystem;
  private playerStats!: PlayerStats;
  private bombSystem!: BombSystem;

  create(config: StageConfig) {
    this.playerStats = new PlayerStats(config.lossCondition, config.bomb);
    this.trajectorySystem = new TrajectorySystem(config.spawn.paths);
    this.enemySpawner = new EnemySpawner(this, config.spawn, config.wordPool, this.trajectorySystem);
    this.typingSystem = new TypingSystem(this.input.keyboard, this.enemySpawner, this.bombSystem);
    this.scoreSystem = new ScoreSystem();
    this.bombSystem = new BombSystem(config.bomb);

    EventBus.on('enemy:cleared', this.onEnemyCleared, this);
    EventBus.on('enemy:breached', this.onEnemyBreached, this);
    EventBus.on('typing:miss', this.onMiss, this);
    EventBus.on('bomb:activated', this.onBombActivated, this);

    this.scene.run('UIScene', { stats: this.playerStats, bomb: this.bombSystem });
  }

  update(time: number, delta: number) {
    this.enemySpawner.update(time, delta);
    this.playerStats.update(delta);
    this.bombSystem.update(delta);

    if (this.playerStats.isDefeated()) {
      this.scene.stop('UIScene');
      this.scene.start('ResultScene', { score: this.scoreSystem.summary() });
    }
  }
}
```

## 9. 里程碑规划
1. **前期准备与框架搭建**
   - 初始化 Vite + Phaser + TypeScript 项目结构与资源加载流程。
   - 实现 BootScene、MenuScene、基础 UI 与全局事件总线。
2. **核心战斗机制实现**
   - 完成 TypingSystem 与箭矢发射流程，确保正确输入即可命中敌人。
   - 构建 EnemySpawner 与 TrajectorySystem，实现敌人下落与多路径支持。
   - 引入 BombSystem 与 HUD 显示，支持手动触发炸弹并清除敌人。
3. **内容扩展与数值调优**
   - 丰富词库、关卡波次、敌人类型及炸弹掉落规则。
   - 加入音效、美术特效、命中与警报反馈，完善敌人行为动画。
4. **打磨与发布准备**
   - 优化性能（对象池、轨迹计算）、强化设置与可访问性选项。
   - 整合排行榜、成就与教学模式，完成打包部署与说明文档。

## 10. 可选扩展
- 实时/异步守城竞速模式，与好友比拼守城时长。
- 自定义词库导入与学习统计（常错词、复习计划）。
- 主题皮肤、游侠装备进阶系统。
- 移动端适配与触屏输入方案。

## 11. 下一步计划
1. 建立基本场景循环并渲染游侠、城墙与敌人原型。
2. 实现输入命中→箭矢发射→敌人被击落的最小可行链路。
3. 为炸弹提供 UI 触发、冷却与清屏反馈，确保基础体验完整。
4. 根据测试结果迭代敌人路径、词库与音效表现。
